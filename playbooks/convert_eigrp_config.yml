---
- name: This playbook will convert a traditional eigrp config to named mode
  gather_facts: no
  hosts: vIOS
  connection: network_cli
  vars:
    general_commands: []
    topology_base_commands: []
    non_passive_interfaces: []

  tasks:
    - name: gather necessary info and store into variables
      ios_command:
        commands: show run | s router eigrp
      register: eigrp_config

    - name: Find and store first eigrp statements for any AS
      set_fact:
        AS: "{{ eigrp_config.stdout_lines[0][0].split()[2] }}"

    - name: Find and store general eigrp commands
      set_fact:
        general_commands: "{{ general_commands }} + [ '{{ item }}' ]"
      with_items: "{{ eigrp_config.stdout_lines[0] }}"
      when: ('network' in item) or (item[:6] == ' eigrp')

    - name: Find and store topology base commands
      set_fact:
        topology_base_commands: "{{ topology_base_commands }} + [ '{{ item }}' ]"
      with_items: "{{ eigrp_config.stdout_lines[0] }}"
      when: ('distribute-list' in item) or ('redistribute' in item)

    - name: Find and store interfaces that are supposed to be no-passive
      set_fact:
        non_passive_interfaces: "{{ non_passive_interfaces }} + [ '{{ item.split()[2] }}' ]"
      with_items: "{{ eigrp_config.stdout_lines[0] }}"
      when:
        - "' no passive-interface' in item"

    - name: send new config to device
      ios_config:
        src: test.j2
        backup: yes
        backup_options:
          filename: "{{ inventory_hostname}}_backup.cfg"
          dir_path: /home/user
        before:
          - no router eigrp {{ AS }}